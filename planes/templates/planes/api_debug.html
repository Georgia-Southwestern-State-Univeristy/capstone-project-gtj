{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <h1>Amadeus Flight API Debug</h1>
    
    <div class="card">
        <div class="card-header">
            <h2>Test API Endpoints</h2>
        </div>
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                <div class="form-group">
                    <label for="api_call_type">API Call Type:</label>
                    <select name="api_call_type" id="api_call_type" class="form-control" required>
                        <option value="airport_search">Airport Search</option>
                        <option value="flight_search">Flight Search</option>
                        <option value="flight_prices">Flight Price Analysis</option>
                    </select>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="origin">Origin:</label>
                            <input type="text" name="origin" id="origin" 
                                   class="form-control" 
                                   placeholder="Enter 3-letter IATA code (e.g., NYC)" 
                                   required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="destination">Destination:</label>
                            <input type="text" name="destination" id="destination" 
                                   class="form-control" 
                                   placeholder="Enter 3-letter IATA code (e.g., LON)" 
                                   required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="departure_date">Departure Date:</label>
                            <input type="date" name="departure_date" id="departure_date" 
                                   class="form-control"
                                   value="{{ default_dates.departure }}"
                                   required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="return_date">Return Date (optional):</label>
                            <input type="date" name="return_date" id="return_date" 
                                   class="form-control"
                                   value="{{ default_dates.return }}">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="adults">Adults:</label>
                    <input type="number" name="adults" id="adults" 
                           class="form-control" 
                           value="1" min="1" max="9">
                </div>
                
                <button type="submit" class="btn btn-primary">Test API</button>
            </form>
        </div>
    </div>
    
    {% if test_cases %}
    <div class="card mt-4">
        <div class="card-header">
            <h3>Test Edge Cases</h3>
        </div>
        <div class="card-body">
            <p>Common edge cases for flight API testing:</p>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Test Case</th>
                            <th>Description</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for test in test_cases %}
                        <tr>
                            <td>{{ test.name }}</td>
                            <td>
                                {% if test.name == 'Invalid Origin' %}
                                    Test with a non-existent airport code for origin
                                {% elif test.name == 'Invalid Destination' %}
                                    Test with a non-existent airport code for destination
                                {% elif test.name == 'Past Date' %}
                                    Test with a departure date in the past
                                {% elif test.name == 'Same Day Return' %}
                                    Test with return date same as departure
                                {% elif test.name == 'Return Before Departure' %}
                                    Test with return date before departure
                                {% elif test.name == 'Zero Passengers' %}
                                    Test with zero passengers
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="loadTestCase('{{ test.name|escapejs }}')">
                                    Load Test
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if error %}
    <div class="alert alert-danger mt-4">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}
    
    {% if request_params %}
    <div class="card mt-4">
        <div class="card-header">
            <h3>Request Parameters</h3>
        </div>
        <div class="card-body">
            <pre>{{ request_params|pprint }}</pre>
        </div>
    </div>
    {% endif %}
    
    {% if api_response %}
    <div class="card mt-4">
        <div class="card-header">
            <h3>API Response</h3>
        </div>
        <div class="card-body">
            <pre style="max-height: 500px; overflow-y: auto;">{{ api_response }}</pre>
        </div>
    </div>
    {% endif %}
    
    {% if results %}
    <div class="card mt-4">
        <div class="card-header">
            <h3>Results Overview</h3>
        </div>
        <div class="card-body">
            {% if request_params.api_call_type == 'airport_search' %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>IATA Code</th>
                                <th>Name</th>
                                <th>City</th>
                                <th>Country</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for airport in results %}
                            <tr>
                                <td>{{ airport.iataCode }}</td>
                                <td>{{ airport.name }}</td>
                                <td>{{ airport.address.cityName }}</td>
                                <td>{{ airport.address.countryName }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% elif request_params.api_call_type == 'flight_search' %}
                <div class="flight-offers">
                    {% for flight in results %}
                    <div class="flight-card mb-4">
                        <h4>Flight Offer #{{ forloop.counter }}</h4>
                        <p>Price: {{ flight.price.total }} {{ flight.price.currency }}</p>
                        
                        {% for itinerary in flight.itineraries %}
                        <div class="itinerary-card mb-3">
                            <h5>{% if forloop.counter0 == 0 %}Outbound{% else %}Return{% endif %}</h5>
                            
                            {% for segment in itinerary.segments %}
                            <div class="segment-card">
                                <p>{{ segment.departure.iataCode }} â†’ {{ segment.arrival.iataCode }}</p>
                                <p>Flight: {{ segment.carrierCode }} {{ segment.number }}</p>
                                <p>Departure: {{ segment.departure.at }}</p>
                                <p>Arrival: {{ segment.arrival.at }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            {% elif request_params.api_call_type == 'flight_prices' %}
                <div class="price-analysis">
                    <h4>Price Analysis</h4>
                    <p>Base Price: {{ results.flightOffers.0.price.base }} {{ results.flightOffers.0.price.currency }}</p>
                    <p>Total Price: {{ results.flightOffers.0.price.total }} {{ results.flightOffers.0.price.currency }}</p>
                    
                    {% if results.flightOffers.0.price.fees %}
                    <h5>Fees:</h5>
                    <ul>
                        {% for fee in results.flightOffers.0.price.fees %}
                        <li>{{ fee.type }}: {{ fee.amount }} {{ results.flightOffers.0.price.currency }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    
                    {% if results.flightOffers.0.price.taxes %}
                    <h5>Taxes:</h5>
                    <ul>
                        {% for tax in results.flightOffers.0.price.taxes %}
                        <li>{{ tax.code }}: {{ tax.amount }} {{ results.flightOffers.0.price.currency }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}