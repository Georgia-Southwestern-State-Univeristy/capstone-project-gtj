{% extends 'base.html' %}
{% load static %}
{% csrf_token %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Booking</title>
    <link rel="stylesheet" href="{% static 'planes\css\FlightsFirstPg.css' %}">
   
</head>
<body>
    <div class="header">
        <div>GTJGo Logo</div>
        <div class="nav">
            <a href="{% url 'main:home' %}">Home</a>
            <a href="{% url 'planes:home' %}">Flights</a>
            <a href="{% url 'hotels:home' %}">Hotels</a>
            <a href="{% url 'transport:home' %}">Rentals</a>
            {% if user.is_authenticated %}
            <a href="{% url 'favorites:view_favorites' %}">Favorites</a>
            {% endif %}
        </div>
    </div>
    <div class="container">
        <h2>Most Affordable Flights to Japan</h2>
        <div class="trip-type">
            <div class="active">Roundtrip</div>
            <div>One-way</div>
        </div>
    
        <form method="GET" id="flightSearch">
            <div class="input-container">
                <div class="input-box">
                    Leaving From
                    <input type="text" 
                           id="origin" 
                           name="origin" 
                           placeholder="Enter departure airport" 
                           required 
                           value="{{ request.GET.origin }}"
                           autocomplete="off">
                    <div id="originSuggestions" class="suggestions"></div>
                </div>
    
                <div class="input-box">
                    Going To
                    <input type="text" 
                           id="destination" 
                           name="destination" 
                           placeholder="Enter destination airport" 
                           required 
                           value="{{ request.GET.destination }}"
                           autocomplete="off">
                    <div id="destinationSuggestions" class="suggestions"></div>
                </div>
    
                <div class="input-box">
                    Departing
                    <input type="date" name="departure_date" required value="{{ request.GET.departure_date }}">
                </div>
    
                <div class="input-box">
                    Returning
                    <input type="date" name="return_date" value="{{ request.GET.return_date }}">
                </div>
    
                <div class="dropdown" onclick="toggleDropdown('travelersDropdown')">Travelers
                    <div id="travelersDropdown" class="dropdown-content">
                        Adults: <input type="number" name="adults" value="{{ request.GET.adults|default:2 }}" min="1"><br>
                    </div>
                </div>

    
                <button type="submit">Search</button>
            </div>
        </form>

    {% if error %}
        <div style="color: red; margin: 10px 0;">
            {{ error }}
        </div>
    {% endif %}

    {% if flights %}
        {% for flight in flights %}
            <div class="flight-card">
                {% for itinerary in flight.itineraries %}
                    {% for segment in itinerary.segments %}
                        <div class="flight-details">
                            <p>From: {{ segment.departure.iataCode }}</p>
                            <p>To: {{ segment.arrival.iataCode }}</p>
                            <p>Departure: {{ segment.departure.at }}</p>
                            <p>Arrival: {{ segment.arrival.at }}</p>
                            <p>Flight: {{ segment.carrierCode }}{{ segment.number }}</p>
                        </div>
                    {% endfor %}
                {% endfor %}
                <p class="price">Price: {{ flight.price.total }} {{ flight.price.currency }}</p>
                
                <button class="favorite-btn" onclick="addToFavorites('FLIGHT', {
                    departure: '{{ flight.itineraries.0.segments.0.departure.iataCode }}',
                    arrival: '{{ flight.itineraries.0.segments.0.arrival.iataCode }}',
                    departure_time: '{{ flight.itineraries.0.segments.0.departure.at }}',
                    flight_number: '{{ flight.itineraries.0.segments.0.carrierCode}}{{ flight.itineraries.0.segments.0.number }}',
                    price: '{{ flight.price.total }} {{ flight.price.currency }}'
                })">Add to Favorites</button>
            </div>
        {% endfor %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Airport search functionality
    const originInput = document.getElementById('origin');
    const destinationInput = document.getElementById('destination');
    const originSuggestions = document.getElementById('originSuggestions');
    const destinationSuggestions = document.getElementById('destinationSuggestions');

    async function searchAirports(keyword, suggestionBox, input) {
        if (keyword.length < 2) {
            suggestionBox.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/planes/search-airports/?keyword=${keyword}`);
            const data = await response.json();
            
            suggestionBox.innerHTML = '';
            data.forEach(airport => {
                const div = document.createElement('div');
                div.className = 'suggestion';
                div.textContent = `${airport.iataCode} - ${airport.name}`;
                div.addEventListener('click', () => {
                    input.value = airport.iataCode;
                    suggestionBox.innerHTML = '';
                });
                suggestionBox.appendChild(div);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    let debounceTimer;
    
    function debounce(func, wait) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(func, wait);
    }

    // Add airport search listeners
    originInput.addEventListener('input', (e) => {
        debounce(() => searchAirports(e.target.value, originSuggestions, originInput), 300);
    });

    destinationInput.addEventListener('input', (e) => {
        debounce(() => searchAirports(e.target.value, destinationSuggestions, destinationInput), 300);
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.input-container')) {
            originSuggestions.innerHTML = '';
            destinationSuggestions.innerHTML = '';
        }
    });

    // Handle dropdowns
    window.onclick = function(event) {
        if (!event.target.matches('.dropdown')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    };
});

// Functions that need to be global
function toggleDropdown(id) {
    document.getElementById(id).classList.toggle('show');
}

function addToFavorites(type, itemData) {
    console.log('Adding to favorites:', {type, itemData});  // Debug log
    
    fetch('/favorites/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            type: type,
            item_data: itemData
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response:', data);  // Debug log
        if (data.status === 'success') {
            alert('Added to favorites!');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding to favorites');
    });
}
</script>
{% endblock %}